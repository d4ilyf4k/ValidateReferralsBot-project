from aiogram import Router, F, types
from database.db_manager import get_referral_link, add_user_bank
from utils.keyboards import get_bank_kb, get_user_main_menu_kb
from services.bonus_calculator import recalculate_all_bonuses

router = Router()

@router.message(F.text == "üè¶ –í—ã–±—Ä–∞—Ç—å –±–∞–Ω–∫")
async def choose_bank(message: types.Message):
    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã:",
        reply_markup=get_bank_kb()
    )

@router.message(F.text.in_(["üè¶–¢-–ë–∞–Ω–∫", "üè¶–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫"]))
async def send_bank_info_and_link(message: types.Message):
    bank_key = "t-bank" if message.text == "üè¶–¢-–ë–∞–Ω–∫" else "alpha"
    
    await add_user_bank(message.from_user.id, bank_key)

    await recalculate_all_bonuses(message.from_user.id)

    if bank_key == "t-bank":
        desc = (
            "<b>üè¶ –¢-–ë–∞–Ω–∫ (–¢–∏–Ω—å–∫–æ—Ñ—Ñ) | –î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞</b>\n\n"
            
            "<b>üìã –£—Å–ª–æ–≤–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞:</b>\n\n"
            "‚Ä¢‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å <b>–¥–µ–±–µ—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É –¢-–ë–∞–Ω–∫–∞</b>\n"
            "‚Ä¢‚úÖ <b>–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É</b> –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è ‚Äî –ø–æ–ø–æ–ª–Ω–∏—Ç—å –µ—ë –Ω–∞ –ª—é–±—É—é —Å—É–º–º—É\n"
                                    
            "<b>‚ú® –û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è:</b>\n"
            "‚Ä¢ <b>–°–æ–≤–µ—Ä—à–∏—Ç—å –ø–µ—Ä–≤—É—é –ø–æ–∫—É–ø–∫—É</b> ‚Äî –æ–Ω–ª–∞–π–Ω –∏–ª–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –Ω–∞ —Å—É–º–º—É –æ—Ç 500 —Ä—É–±–ª–µ–π\n\n"
            
            "<b>üí∞ –ß—Ç–æ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å:</b>\n\n"
            "‚Ä¢‚úÖ –í—Å–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–∞—Ä—Ç—ã –¢-–ë–∞–Ω–∫–∞ (–ø—Ä–æ—Ü–µ–Ω—Ç—ã –Ω–∞ –æ—Å—Ç–∞—Ç–æ–∫, –∫–µ—à–±—ç–∫)\n"
            "‚Ä¢‚úÖ –ü—Ä–∏—è—Ç–Ω—ã–π –±–æ–Ω—É—Å –≤ —Ä–∞–∑–º–µ—Ä–µ 500‚ÇΩ –∑–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã!\n\n"
            
            "<b>‚è±Ô∏è –°—Ä–æ–∫–∏:</b>\n"
            "–ë–æ–Ω—É—Å –∑–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ <b>5‚Äì10 –¥–Ω–µ–π</b> –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π.\n\n"
            "<i>üìå –ë–æ—Ç –±—É–¥–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∏ –Ω–∞–ø–æ–º–Ω–∏—Ç –¥—Ä—É–≥—É –æ –≤—ã–ø–ª–∞—Ç–µ —Ç–≤–æ–µ–≥–æ –±–æ–Ω—É—Å–∞!</i>\n\n"
            "<b>–ì–æ—Ç–æ–≤ –ø–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç—É –∏ –±–æ–Ω—É—Å?</b>"
        )
    else:  # alpha
        desc = (
            "<b>üè¶ –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫ | –î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞</b>\n\n"
                        
            "<b>üìã –£—Å–ª–æ–≤–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞:</b>\n"
            "‚Ä¢‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å <b>–¥–µ–±–µ—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫–∞</b>\n"
            "‚Ä¢‚úÖ <b>–ü–æ–ª—É—á–∏—Ç—å –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É</b> –ø–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è\n\n"
                        
            "<b>‚ú® –û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è:</b>\n"
            "‚Ä¢ <b>–°–æ–≤–µ—Ä—à–∏—Ç—å –ø–µ—Ä–≤—É—é –ø–æ–∫—É–ø–∫—É</b> ‚Äî –æ–Ω–ª–∞–π–Ω –∏–ª–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –Ω–∞ –ª—é–±—É—é —Å—É–º–º—É\n\n"
            
            "<b>üí∞ –ß—Ç–æ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å:</b>\n"
            "‚Ä¢‚úÖ –í—Å–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–∞—Ä—Ç—ã –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫–∞ (–ø—Ä–æ—Ü–µ–Ω—Ç—ã, –∫–µ—à–±—ç–∫, –º–∏–ª–∏)\n"
            "‚Ä¢‚úÖ <b>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–Ω—É—Å –≤ —Ä–∞–∑–º–µ—Ä–µ 500‚ÇΩ –∑–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã!</b>\n\n"
            
            "<b>‚è±Ô∏è –°—Ä–æ–∫–∏:</b>\n"
            "–ë–æ–Ω—É—Å –∑–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ <b>3‚Äì14 –¥–Ω–µ–π</b> –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π.\n\n"
            "<i>üìå –ë–æ—Ç –±—É–¥–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∏ –Ω–∞–ø–æ–º–Ω–∏—Ç –¥—Ä—É–≥—É –æ –≤—ã–ø–ª–∞—Ç–µ —Ç–≤–æ–µ–≥–æ –±–æ–Ω—É—Å–∞!</i>\n\n"
            "<b>–ì–æ—Ç–æ–≤ –ø–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç—É –∏ –±–æ–Ω—É—Å?</b>"
        )
    await message.answer(desc, parse_mode="HTML")

    link = await get_referral_link(bank_key)
    if link:
        bank_name = "–¢-–ë–∞–Ω–∫–∞" if bank_key == "t-bank" else "–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫–∞"
        await message.answer(f"üìé –í–∞—à–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã {bank_name}:\n{link}")
    else:
        await message.answer("‚ö†Ô∏è –°—Å—ã–ª–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")

    await message.answer("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=get_user_main_menu_kb())